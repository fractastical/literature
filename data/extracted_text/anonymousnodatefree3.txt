arXiv:cond-mat/0109461v1  [cond-mat.stat-mech]  25 Sep 2001
Targeted free energy perturbation
C. Jarzynski
Complex Systems, T-13, MS B213
Los Alamos National Laboratory
Los Alamos, NM 87545
chrisj@lanl.gov
LAUR-01-2157
Abstract
A generalization of the free energy perturbation identity i s derived, and a
computational strategy based on this result is presented. A simple example
illustrates the eﬃciency gains that can be achieved with thi s method.
The development of eﬃcient methods for the numerical estimation o f free energy diﬀer-
ences remains an outstanding problem in the computational science s [1], with applications
as diverse as rational drug design [2], ab initio prediction of material properties [3], and the
study of condensates in non-perturbative QCD [4]. Many schemes f or estimating free energy
diﬀerences trace their origins to the perturbation identity [5],
⣨
e−∆ E/kT
⟩
A
= e−∆ F/kT . (1)
Here, ∆ F = FB − FA is the Helmholtz free energy diﬀerence between two equilibrium state s
of a system, A and B, deﬁned at a common temperature T but diﬀerent settings of external
parameters. The variable x (and later y) denotes a microstate of the system, e.g. a point
in conﬁguration space or phase space; EA(x) and EB(x) denote the internal energy as a
function of microstate, for the two parameter settings; and
∆ E(x) ≡ EB(x) − EA(x) (2)
is the energy diﬀerence associated with changing the external par ameters from one setting
to the other, while holding ﬁxed the microstate. Finally, ⟨· · ·⟩A denotes an average over
microstates sampled from the canonical distribution representing state A.
The traditional perturbation approach to estimating ∆ F is a direct application of Eq.1:
the quantity exp( −∆ E/kT ) is averaged over microstates sampled from ensemble A. [6]
However, this method converges poorly when there is little overlap in conﬁguration space
between ensembles A and B. Intuitively, this makes sense: if there is little overlap, then
we very slowly accumulate information about state B by generating microstates typical of
state A.
The aim of this paper is to present a generalization of Eq.1, as well as a computational
method, targeted free energy perturbation , based on this result. The practitioner of this
1
method must attempt to construct an invertible transformation M, under which ensemble
A gets mapped onto an ensemble A′ which overlaps signiﬁcantly with B (see Eqs.13, 14). The
more successful this attempt, the more rapidly the method conve rges. Indeed, if A′ and B
overlap perfectly, then convergence is immediate! This strategy t hus provides a mechanism
for taking advantage of prior knowledge about states A and B (used to construct the mapping
M) in order to speed up the estimation of ∆ F .
While the central result and method derived below are new, the use o f invertible map-
pings to enhance the eﬃciency of free energy calculations has prec edents. For simple dis-
placements, x → x+d, the method proposed herein is closely related to one developed yea rs
ago by Voter [7], for energy functions EA and EB which resemble one another apart from
a spatial translation. Bruce et al [8] have proposed the use of invertible transformations
as collective Monte Carlo moves – “lattice switches” – to enable the sa mpling of disparate
regions of conﬁguration space. Finally, our method is similar in spirit to the metric scaling
scheme developed by Miller and Reinhardt [9], whereby one attempts t o “guide” the sys-
tem in question through a continuous sequence of equilibrium states , by dynamically, and
linearly, distorting the space in which the constituent particles evolv e.
We now derive our central result, Eq.10 below.
Consider an invertible transformation of conﬁguration space onto itself:
M : x → y(x). (3)
This might be a displacement as in Ref. [7], or perhaps a scaling transfo rmation as in Ref.
[9], or it might be a considerably more complicated, nonlinear mapping. N ow imagine
microstates x1, x2, · · · sampled from some (so far, arbitrary) primary ensemble, represented
by a distribution ρ(x); and construct their images under the transformation: y1, y2, · · ·,
where yn = M(xn). The y’s are, eﬀectively, sampled from a secondary ensemble, which is
the image of the primary ensemble under M. This secondary ensemble is represented by a
distribution η(·), related to the primary distribution ρ(·) by:
η(y) = ρ(x)/J(x), (4)
where J(x) = |∂y/∂x| is the Jacobian of the mapping M. Here and henceforth, when the
variables x and y appear together, it will be understood that they are related by y = M(x).
Next, deﬁne a function
Φ( x) ≡ EB(y) − EA(x) − kT ln J(x), (5)
let the primary ensemble be the canonical distribution correspondin g to state A,
ρ(x) = 1
ZA
e−EA(x)/kT , (6)
and evaluate the average of exp( −Φ /kT ) over points x sampled from this ensemble:
⣨
e−Φ /kT
⟩
A
=
∫
dx ρ(x) e−Φ( x)/kT (7)
= 1
ZA
∫
dx J(x)e−EB(y)/kT (8)
= 1
ZA
∫
dy e−EB (y)/kT = ZB
ZA
, (9)
2
where ZA and ZB are partition functions. (Note the change in the variable of integra tion:∫
J d x · · · =
∫
dy · · ·.) Invoking the relation F = −kT ln Z, we ﬁnally obtain
⣨
e−Φ /kT
⟩
A
= e−∆ F/kT . (10)
Let us now turn our attention to the application of this result to the problem of estimating
∆ F .
Eq.10 generalizes of the free energy perturbation identity, reduc ing to the latter in the
special case M : x → x. However, Eq.10 is valid for arbitrary invertible transformations
M. It is plausible that one can take advantage of this generalit y to enhance the eﬃciency of
computing ∆ F . That is, there may exist mappings M for which the average of exp( −Φ /kT )
converges more rapidly than the average of exp( −∆ E/kT ).
To investigate this possibility, consider p(φ|M), the distribution of values of φ = Φ( x),
for x sampled from A (Eq.6). Eq.10 asserts that
∫
dφ p(φ|M) e−φ/kT = e−∆ F/kT , (11)
for any choice of M. In practice, we estimate ∆ F by averaging exp( −Φ /kT ) over a ﬁnite
number of sampled microstates x1, x2, · · · , xN :
1
N
N∑
n=1
e−φ n/kT ≈ e−∆ F/kT , (12)
where φn ≡ Φ( xn). This approximation becomes an equality as N → ∞ , but the rate
of convergence depends strongly on the choice of M; roughly speaking, the narrower the
distribution p(φ|M), the faster the convergence. Therefore we are faced with the practical
question, how do we choose M so as to maximize the rate of convergence of the left side of
Eq.12?
Recall that poor convergence of the usual perturbation method is a symptom of too
little overlap between A and B in conﬁguration space: we then learn little about B when
sampling from A. Now note that, when generating the sequence of φn’s, we are eﬀectively
harvesting information from two ensembles; the points x sample the primary ensemble A,
while the points y sample the secondary ensemble, A′, which is the image of A under the
transformation M:
A M− →A′. (13)
Intuition suggests that, since the primary ensemble represents s tate A (by construction), we
ought to attempt to maximize the overlap between the secondary e nsemble and state B,
A′ ≈ B, (14)
so as to speedily gain information about both of the equilibrium states (A and B) which
interest us.
Pursuing this line of intuition, let us ﬁrst consider the extreme case, and deﬁne a perfect
transformation M∗ to be one under which A maps exactly onto B:
3
ρ(x) = 1
ZA
e−EA(x)/kT M∗
− → η(y) = 1
ZB
e−EB(y)/kT . (15)
By Eq.4, this implies
FB − EB(y) = FA − EA(x) − kT ln J(x), (16)
in other words Φ( x) = ∆ F for all x. Hence, we have a maximally narrow distribution of
values of φ:
p(φ|M∗) = δ(φ − ∆ F ). (17)
Thus, the convergence of Eq.12 is immediate if the transformation is perfect : Φ( x) = ∆ F
for every sampled x.
Unfortunately, constructing a perfect transformation is likely to be much more diﬃcult
than the original problem of computing ∆ F . However, it stands to reason that if p(φ|M)
is a delta-function when A′ = B, then it will remain narrow when A′ ≈ B. Eq.17 thus
gives credence to our earlier intuition (Eq.14): we ought indeed to loo k for a transformation
under which A′ enjoys good overlap with B. A close resemblance between A′ and B implies
a narrow distribution of φ’s, which in turn implies rapid convergence of our estimate of ∆ F .
Let us summarize what has been stated to this point. Eq.10 suggest s a method of estimat-
ing ∆ F : microstates xn are sampled from the canonical ensemble A; the value φn = Φ( xn)
is computed for each sampled microstate; and the estimator XN ≡ (1/N) ∑
n exp(−φn/kT )
converges to exp( −∆ F/kT ) as N → ∞ . Two ingredients of this scheme are: an invert-
ible mapping M, and the image A′ of the canonical ensemble A under M. If A′ coincides
with B, then the method converges immediately. Hence, if we choose a tra nsformation M
which signiﬁcantly improves the overlap with B, without necessarily being “perfect”, then
XN ought to converge more rapidly with N than the traditional free energy perturbation
estimator, XFEP
N ≡ (1/N)
∑
n exp(−∆ En/kT ). We will refer to this method as targeted free
energy perturbation, since its successful implementation requires ﬁnding a transforma tion M
for which the secondary ensemble A′ comes reasonably close to “hitting” the target ensemble,
B.
Several potential extensions of targeted free energy perturb ation, to be developed more
fully elsewhere, suggest themselves. First, for a parameter-dep endent energy function
E(x, λ), the application of Eq.10, to states A and B deﬁned by inﬁnitesimally diﬀerent
values of λ, leads to the identity
∂F
∂λ =
⟨
∂E
∂λ + u · ∇E − kT ∇ · u
⟩
λ
, (18)
where u(x) is an arbitrary diﬀerentiable vector ﬁeld of bounded magnitude [10] While this
result reduces to the widely used thermodynamic integration identit y [11] for u = 0, other
choices of u might accelerate convergence of the average. It is also straightf orward to in-
corporate Eq.10 into the umbrella sampling [12] and overlapping distrib utions [13] methods.
Finally, a nonlinear metric scaling scheme – with particular potential for enhancing the e f-
ﬁciency of free energy calculations based on steered molecular dyn amics [14] – might result
from combining the approach of the present paper with that of Ref . [9].
4
The utility of targeted free energy perturbation depends critically on our ability to con-
struct a mapping M appropriate to the problem at hand. While intuition will in some
cases reliably suggest a candidate, in others it may be very diﬃcult or computationally
expensive to devise a mapping which improves the overlap with ensemb le B. In the case
of non-diﬀusive systems, however, a promising and quite general strategy exists . [15] For
a quasi-rigid system such as a large molecule, the canonical ensemble occupies a strongly
localized region of conﬁguration space (assuming that the translat ional and rotational de-
grees of freedom of the entire molecule have been integrated out, or else pinned down by a
constraining potential). Given two such molecules, A and B – alchemically diﬀerent, hence
represented by diﬀerent energy functions [16] – we can roughly ap proximate the associated
canonical ensembles by Gaussian distributions in the many-dimension al conﬁguration space.
[17] A reasonable candidate for M is then the linear transformation which converts one of
these Gaussians into the other. Even if the Gaussian approximation is quite crude, the
mapping thus constructed is likely to result in a signiﬁcantly improved o verlap between A′
and B (relative to that between A and B).
We end this paper with numerical results illustrating the targeted fr ee energy pertur-
bation method. The setting is the expansion of a cavity in a ﬂuid. While t he aim here is
simply a comparison between methods, it bears mention that recent years have seen renewed
theoretical interest in the problem of cavity formation in ﬂuids [18], b oth as a fundamental
problem in physical chemistry, and because of the role played by hyd rophobicity in deter-
mining and stabilizing protein structure.
Consider np point molecules conﬁned within a cubic container of volume L3, but excluded
from a spherical cavity of radius R located at the center ( r = 0) of the container. Assume
periodic boundary conditions and a pairwise interaction Vint(ri, rj) between molecules. We
can write the energy function for such a ﬂuid as:
E(x; R) = Θ( x; R) +
∑
i<j
Vint(ri, rj). (19)
Here, x = ( r1, · · · , rnp ) speciﬁes the microstate, and Θ( x; R) is either 0 (if all ri > R )
or + ∞ (otherwise), thus enforcing the exclusion of molecules from the sp herical cavity.
Treating the cavity radius R as an external parameter, let us choose two values, RA and
RB, satisfying 0 < R A < R B < L/ 2, and let A and B denote the corresponding equilibrium
states (canonical ensembles), at a given temperature T . We want to compute the associated
free energy diﬀerence, ∆ F = FB − FA. Physically, this is the reversible, isothermal work
required to expand the cavity radius from RA to RB.
The quantity exp( −∆ F/kT ) is equal to the probability P that, given a microstate x
sampled from ensemble A, the region RA < r ≤ RB will be devoid of molecules. This can be
viewed as a consequence of Eq.1, noting that ∆ E is equal to either 0 or + ∞, depending on
whether or not this region is vacant. The application of the tradition al perturbation method
amounts to evaluating this probability by straight sampling.
Let us now try to construct a transformation M which improves the eﬃciency of es-
timating P = exp( −∆ F/kT ). With the traditional method, poor convergence arises if
P ≪ 1, i.e. if for nearly every microstate x ∈ A, there will be molecules located in the
region RA < r ≤ RB. Therefore let us choose M so as to vacate this region. A candidate
transformation [19], acting on each particle independently, is:
5
ri → g(ri) ri , i = 1 , · · · , np, (20)
where
g(r) =
[
1 + (R3
B − R3
A)(L3 − 8r3)
(L3 − 8R3
A)r3
]1/ 3
(21)
if RA < r ≤ L/2, and g(r) = 1 otherwise. Under this transformation, the region of space
deﬁned by RA < r ≤ L/2 gets uniformly compressed into the region RB < r ≤ L/2. For any
x sampled from A, the quantity EB(y) − EA(x) is just the change in the total interaction
energy ( ∑ Vint) resulting from this compression, and
J(x) = [( L3 − 8R3
B)/(L3 − 8R3
A)]ν(x), (22)
where ν(x) is the number of molecules in the region RA < r ≤ L/2.
We simulated 125 molecules inside a container of sides L = 22 .28 ˚
A, at T = 300 K. A
Lennard-Jones interaction between molecules was used, with para meters corresponding to
argon [20] ( σ = 3 .542˚
A, ǫ = 0 .1854kcal/mol). The values of RA and RB were taken to be
9.209 ˚
A and 9 .386 ˚
A, respectively.
Sampling from ensemble A was achieved with the Metropolis algorithm. Three inde-
pendent runs were carried out, each consisting of 500 initial relaxa tion sweeps followed by
2×105 production sweeps. These runs were used to estimate P = exp( −∆ F/kT ), using both
the traditional perturbation approach (i.e. observing the freque ncy with which the region
RA < r ≤ RB is spontaneously vacant) and targeted perturbation (Eq.12). In Fig.1, each
red curve shows the traditional perturbation estimate of P for a single run, accumulating as
a function of number of production sweeps, N (plotted in increments of ∆ N = 1000). The
blue curves show the targeted perturbation estimates for the sa me runs. It is evident that
the latter converge much faster than the former. Combining the d ata from all three runs, the
two methods yield the estimates P est
trad = (4 .83±0.49)×10−4 and P est
targ = (5 .81±0.05)×10−4.
The error bars are 1 σ, and their ratio suggests that eﬃciency in this case is improved by
about two orders of magnitude by using targeted (rather than tr aditional) free energy per-
turbation.
It is a pleasure to acknowledge stimulating discussions and correspo ndence with Graeme
Ackland, Alastair Bruce, Angel Garcia, Gabriel Istrate, Lawrenc e Pratt, and Nigel Wilding.
This research is supported by the Department of Energy, under c ontract W-7405-ENG-36.
6
REFERENCES
[1] See e.g. D.Chandler, Introduction to Modern Statistical Mechanics , Oxford University,
New York (1987); D.Frenkel, B.Smit, Understanding Molecular Simulation: From Algo-
rithms to Applications , Academic Press, San Diego (1996).
[2] M.R.Reddy and M.D.Erion, eds., Free Energy Calculations in Rational Drug Design ,
Kluwer Publishing, the Netherlands (2001).
[3] G.J.Ackland, “Calculation of free energies from ab initio calculation” , submitted for
publication.
[4] T.Schafer and E.V.Shuryak, Rev.Mod.Phys. 70, 323 (1998).
[5] R.W.Zwanzig, J.Chem.Phys. 22, 1420 (1954).
[6] Ensembles A and B refer to the two canonical distributions representing the thermo dy-
namic states A and B. By contrast, ensemble A′, deﬁned by Eq.13, does not generally
correspond to a physically interesting canonical distribution.
[7] A.F.Voter, J.Chem.Phys. 82, 1890 (1985).
[8] A.D.Bruce, N.B.Wilding, and G.J.Ackland, Phys.Rev.Lett. 79, 3002 (1997); A.D.Bruce,
A.N.Jackson, G.J.Ackland, and N.B.Wilding, Phys.Rev.E 61, 906 (2000).
[9] M.A.Miller and W.P.Reinhardt, J.Chem.Phys. 113, 7035 (2000).
[10] To derive Eq.18, take M : x → x + u dλ, where dλ is the diﬀerence between the
parameter values deﬁning states A and B, and expand Eq.10 to ﬁrst order in dλ.
[11] J.G.Kirkwood, J.Chem.Phys. 3, 300 (1935).
[12] G.M.Torrie and J.P.Valleau, Chem.Phys.Lett. 28, 578 (1974).
[13] C.H.Bennett, J.Comp.Phys. 22, 245 (1976).
[14] J.R.Gullingsrud, R.Braun, and K.Schulten, J.Comp.Phys. 151, 190 (1999).
[15] This scheme has been suggested independently in the somewhat diﬀerent context of
lattice-switch Monte Carlo; A.Acharya, A.D.Bruce, and G.J.Ackland, in preparation,
and also Ref. [3].
[16] The problem of estimating ∆ F between alchemically diﬀerent molecules or molecular
complexes is a central problem of rational drug design; see Ref. [2].
[17] Extensive research along these lines has been carried out for p rotein molecules; see e.g.
the review by A.Kitao and N.Go, Curr.Op.Struct.Bio. 9, 164 (1999).
[18] See for instance K.Lum, D.Chandler, and J.D.Weeks, J.Phys.Chem.B 103, 4570 (1999);
G.Hummer, S.Garde, A.E.Garcia, and L.R.Pratt, Chem.Phys. 258, 349 (2000); and
related references.
[19] For more complicated geometries, analogous mappings could be c onstructed numerically
at relatively low cost.
[20] R.Reid, J.Prausnitz, T.Sherwood, The Properties of Gases and Liquids , 3rd ed., App.
A and C. McGraw-Hill, New York (1977).
7
FIGURES
FIG. 1. Traditional and targeted free energy perturbation e stimates of P = exp( −∆ F/kT ),
as a function of number of MC sweeps.
8
0
0.0005
0.001
0.0015
0.002
40000 80000 120000 160000 200000
Number of Monte Carlo sweeps
Estimate of P
Traditional FEP
Targeted FEP